<?php
/**
 * Unirgy LLC
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the EULA
 * that is bundled with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.unirgy.com/LICENSE-M1.txt
 *
 * @category   Unirgy
 * @package    Unirgy_DropshipPo
 * @copyright  Copyright (c) 2008-2009 Unirgy LLC (http://www.unirgy.com)
 * @license    http:///www.unirgy.com/LICENSE-M1.txt
 */
?>
<?php
$_hlp = Mage::helper('udropship');
$_poHlp = Mage::helper('udpo');
$_udpos = Mage::helper('core')->decorateArray($_poHlp->getVendorPoCollection(), '');
$_vendor = Mage::getSingleton('udropship/session')->getVendor();
$_poUsedMethods = $_hlp->getUsedMethodsByPoCollection($_udpos);
$_statuses = $_poHlp->getVendorUdpoStatuses();
$_reprintUrl = $this->getUrl('udpo/vendor/reprintLabelBatch/track_id/TRACKID/ajax/1');
$_reprintBatchUrl = $this->getUrl('udpo/vendor/reprintLabelBatch/batch_id/BATCHID/ajax/1');
$_ajaxInfoUrl = $this->getUrl('udpo/vendor/udpoInfo/id/ID/ajax/1');
$_ajaxShipmentInfoUrl = $this->getUrl('udpo/vendor/shipmentInfo/id/ID/ajax/1');
$_ajaxPostUrl = $this->getUrl('udpo/vendor/udpoPost/id/ID/ajax/1');
$_ajaxAddCommentUrl = $this->getUrl('udpo/vendor/addUdpoComment/id/ID/ajax/1');
$_ajaxShipmentPostUrl = $this->getUrl('udpo/vendor/shipmentPost/id/ID/ajax/1');
$_ajaxUdpoDeleteTrackUrl = $this->getUrl('udpo/vendor/udpoDeleteTrack/id/ID/ajax/1');
$_ajaxShipmentDeleteTrackUrl = $this->getUrl('udpo/vendor/shipmentDeleteTrack/id/ID/ajax/1');
$_sortBy = $this->getRequest()->getParam('sort_by');
$_sortDir = $this->getRequest()->getParam('sort_dir');
$_filterMethods = $this->getRequest()->getParam('filter_method');
$_filterStatuses = $this->getRequest()->getParam('filter_status');
$_dateFormat = Varien_Date::convertZendToStrFtime(Mage::app()->getLocale()->getDateFormat(Mage_Core_Model_Locale::FORMAT_TYPE_SHORT), true, false);
?>
<form method="get" id="udpo-filter-form">
    <div class="generic-box filter">
    	<div class="box-head">
            <div class="col3-set">
                <div class="col-1">
                    <a class="action" href="javascript:void(0);" onclick="toggleSGFilterBox(this)"><span class="open"></span></a>
                </div>
                <div class="col-2"><?php echo Mage::helper('udropship')->__('Filter Orders') ?></div>
                <div class="col-3">&nbsp;</div>
            </div>
        </div>
        <div class="col3-set">
        <div class="col-1">
            <ul class="form-list">
                <li>
                    <label for="filter-order_id-from"><?php echo Mage::helper('udropship')->__('Order ID') ?></label><br/>
                    <input id="filter-order_id-from" name="filter_order_id_from" title="<?php echo Mage::helper('udropship')->__('From Order ID') ?>" type="text" class="input-text" style="width:120px;" value="<?php echo $this->getRequest()->getParam('filter_order_id_from') ?>" /> -
                    <input id="filter-order_id-to" name="filter_order_id_to" title="<?php echo Mage::helper('udropship')->__('To Order ID') ?>" type="text" class="input-text" style="width:120px;" value="<?php echo $this->getRequest()->getParam('filter_order_id_to') ?>" />
                </li>
                <li>
                    <label for="filter-order_date-from"><?php echo Mage::helper('udropship')->__('Order Date') ?></label><br/>
                    <input id="filter-order_date-from" name="filter_order_date_from" title="<?php echo Mage::helper('udropship')->__('From Order Date') ?>" type="text" class="input-text" style="width:120px;" value="<?php echo $this->getRequest()->getParam('filter_order_date_from') ?>" /> -
                    <input id="filter-order_date-to" name="filter_order_date_to" title="<?php echo Mage::helper('udropship')->__('To Order Date') ?>" type="text" class="input-text" style="width:120px;" value="<?php echo $this->getRequest()->getParam('filter_order_date_to') ?>" />
                </li>
                <li>
                    <label for="filter-po_id-from"><?php echo Mage::helper('udropship')->__('PO ID') ?></label><br/>
                    <input id="filter-po_id-from" name="filter_po_id_from" title="<?php echo Mage::helper('udropship')->__('From PO ID') ?>" type="text" class="input-text" style="width:120px;" value="<?php echo $this->getRequest()->getParam('filter_po_id_from') ?>" /> -
                    <input id="filter-po_id-to" name="filter_po_id_to" title="<?php echo Mage::helper('udropship')->__('To PO ID') ?>" type="text" class="input-text" style="width:120px;" value="<?php echo $this->getRequest()->getParam('filter_po_id_to') ?>" />
                </li>
                <li>
                    <label for="filter-po_date-from"><?php echo Mage::helper('udropship')->__('PO Date') ?></label><br/>
                    <input id="filter-po_date-from" name="filter_po_date_from" title="<?php echo Mage::helper('udropship')->__('From PO Date') ?>" type="text" class="input-text" style="width:120px;" value="<?php echo $this->getRequest()->getParam('filter_po_date_from') ?>" /> -
                    <input id="filter-po_date-to" name="filter_po_date_to" title="<?php echo Mage::helper('udropship')->__('To PO Date') ?>" type="text" class="input-text" style="width:120px;" value="<?php echo $this->getRequest()->getParam('filter_po_date_to') ?>" />
                </li>
                <li>
                    <label for="filter-sort-by"><?php echo Mage::helper('udropship')->__('Sort By') ?></label><br/>
                    <select id="filter-sort-by" name="sort_by" title="<?php echo Mage::helper('udropship')->__('Sort By') ?>" class="select" style="width:120px;">
                        <option value="order_increment_id" <?php if ($_sortBy=='order_increment_id'):?>selected="selected"<?php endif ?>><?php echo Mage::helper('udropship')->__('Order ID') ?></option>
                        <option value="increment_id" <?php if ($_sortBy=='increment_id'):?>selected="selected"<?php endif ?>><?php echo Mage::helper('udropship')->__('PO ID') ?></option>
                        <option value="order_date" <?php if ($_sortBy=='order_date'):?>selected="selected"<?php endif ?>><?php echo Mage::helper('udropship')->__('Order Date') ?></option>
                        <option value="po_date" <?php if ($_sortBy=='po_date'):?>selected="selected"<?php endif ?>><?php echo Mage::helper('udropship')->__('PO Date') ?></option>
                        <option value="shipping_method" <?php if ($_sortBy=='shipping_method'):?>selected="selected"<?php endif ?>><?php echo Mage::helper('udropship')->__('Delivery Method') ?></option>
                        <option value="udropship_status" <?php if ($_sortBy=='udropship_status'):?>selected="selected"<?php endif ?>><?php echo Mage::helper('udropship')->__('PO Status') ?></option>
                    </select>
                    <select id="filter-sort-dir" name="sort_dir" title="<?php echo Mage::helper('udropship')->__('Direction') ?>" class="select" style="width:100px;">
                        <option value="asc" <?php if ($_sortDir=='asc'):?>selected="selected"<?php endif ?>><?php echo Mage::helper('udropship')->__('Ascending') ?></option>
                        <option value="desc" <?php if ($_sortDir=='desc'):?>selected="selected"<?php endif ?>><?php echo Mage::helper('udropship')->__('Descending') ?></option>
                    </select>
                </li>
            </ul>
        </div>
        <div class="col-2">
            <ul class="form-list">
                <li>
                    <label><?php echo Mage::helper('udropship')->__('Delivery Method') ?></label><br/>
                    <div style="height:200px; overflow-y:auto">
                    <?php foreach ($_poUsedMethods as $_m): $_code =$_m;
                        if ($_code=='VIRTUAL_PO') {
                            $_label = Mage::helper('udropship')->__('VIRTUAL PO');
                        } else {
                            $_label = $_vendor->getShippingMethodName($_code, true);
                        }
                    ?>
                        <label for="filter-method-<?php echo $_code?>"><input id="filter-method-<?php echo $_code?>" name="filter_method[<?php echo $_code ?>]" value="1" title="<?php echo $_label ?>" type="checkbox" class="checkbox" <?php if (!empty($_filterMethods[$_code])):?>checked="checked"<?php endif ?> /> <?php echo $_label ?></label><br/>
                    <?php endforeach ?>
                    </div>
                </li>
            </ul>
        </div>
        <div class="col-3">
            <ul class="form-list">
                <li>
                    <label><?php echo Mage::helper('udropship')->__('Status') ?></label><br/>
                    <?php foreach ($_statuses as $_v=>$_l): ?>
                        <label for="filter-status-<?php echo $_v ?>"><input id="filter-status-<?php echo $_v ?>" name="filter_status[<?php echo $_v ?>]" value="1" title="<?php echo Mage::helper('udropship')->__($_l) ?>" type="checkbox" class="checkbox" <?php if (!empty($_filterStatuses[$_v])):?>checked="checked"<?php endif ?> /> <?php echo Mage::helper('udropship')->__($_l)?></label><br/>
                    <?php endforeach ?>
                </li>
            </ul>
        </div>
        </div>
        <div class="buttons-set">
            <input type="submit" value="search" style="display:none" />
            <input type="hidden" name="apply_filter" value="search"/>
            <button class="form-button" name="reset_filter" type="button" onclick="setLocation('<?php echo $this->getUrl('*/*/*')?>')" id="filter-search" value="search"><span><?php echo Mage::helper('udropship')->__('Reset Filter') ?></span></button>
            <button class="form-button" name="apply_filter" type="submit" id="filter-search" value="search"><span><?php echo Mage::helper('udropship')->__('Apply Filter') ?></span></button>
        </div>
    </div>
</form>




<div class="generic-box">

<form id="udpo-massaction-form">
            <div class="batch-actions">
                <h3 class="f-left"><?php echo Mage::helper('udropship')->__('Orders')
                    ?></h3>
                <strong style="margin-right:5px;">
                    <?php echo Mage::helper('udropship')->__('Perform on all retrieved records') ?>:
                </strong>
                <select id="submit_action" name="submit_action">
                    <option value=""><?php echo Mage::helper('udropship')->__('* No action')?></option>
                    <option value="udpoMultiPdf"><?php echo Mage::helper('udropship')->__('PDF Purchase Orders')?></option>
                    <option value="packingSlips"><?php echo Mage::helper('udropship')->__('Download Packing Slips')?></option>
<?php if ($_vendor->getLabelType()): ?>
                    <option value="udpoLabelBatch"><?php echo Mage::helper('udropship')->__('Create and Download Labels Batch')?></option>
                    <option value="existingLabelBatch"><?php echo Mage::helper('udropship')->__('Download Existing Labels Batch')?></option>
<?php endif ?>
                    <option value="updateUdpoStatus"><?php echo Mage::helper('udropship')->__('Update Status')?></option>
                    <?php if ($_hlp->isModuleActive('Unirgy_DropshipBatch')): ?>
                    <option value="udbatchExport"><?php echo Mage::helper('udropship')->__('Export Purchase Orders')?></option>
                    <?php endif ?>
                    <option value="createShipment"><?php echo Mage::helper('udropship')->__('Create Shipments')?></option>
                    <option value="createShipmentAndEmail"><?php echo Mage::helper('udropship')->__('Create Shipments and Send Customer Notifications')?></option>
                </select>
                <select id="batch_update_status" name="update_status">
                    <option value=""><?php echo Mage::helper('udropship')->__('* Automatic') ?></option>
                    <?php foreach ($_statuses as $_v=>$_l): ?>
                        <option value="<?php echo $_v ?>"><?php echo Mage::helper('udropship')->__($_l) ?></option>
                    <?php endforeach ?>
                </select>
                <?php if ($this->getRequest()->getParam('limit')): ?>
                <input type="hidden" name="limit" value="<?php echo $this->getRequest()->getParam('limit')?>"/>
                <?php endif ?>
                <?php if ($this->getRequest()->getParam('p')): ?>
                <input type="hidden" name="p" value="<?php echo $this->getRequest()->getParam('p')?>"/>
                <?php endif ?>
                <button class="form-button" type="button" onclick="return massActionSubmit(this.form)"><span><?php echo Mage::helper('udropship')->__('Submit') ?></span></button>
            </div>
</form>
            
<p>
    <a href="#" onclick="collapseAllRows(); return false"><?php echo Mage::helper('udropship')->__('Collapse all rows') ?></a> / <a href="#" onclick="expandAllRows(); return false"><?php echo Mage::helper('udropship')->__('Expand all rows') ?></a>
</p>

<div id="debug"></div>

<?php echo $this->getChildHtml('toolbar') ?>
<table cellspacing="0" class="data-table" id="udpo-grid">
    <col width="1" />
    <col />
    <col />
    <col />
    <col />
    <col />
    <col width="1" />
    <col />
    <thead>
        <tr>
            <th><?php echo Mage::helper('udropship')->__('')?></th>
            <th><?php echo Mage::helper('udropship')->__('PO ID')?></th>
            <th><?php echo Mage::helper('udropship')->__('Order ID')?></th>
            <th><?php echo Mage::helper('udropship')->__('Order Date')?></th>
            <th><?php echo Mage::helper('udropship')->__('PO Date')?></th>
            <th><?php echo Mage::helper('udropship')->__('Delivery Method')?></th>
            <th><?php echo Mage::helper('udropship')->__('Status')?></th>
            <th><?php echo Mage::helper('udropship')->__('Items')?></th>
            <th><?php echo Mage::helper('udropship')->__('Download')?></th>
        </tr>
    </thead>
    <tbody>
<?php if ($_udpos): ?>
    <?php foreach ($_udpos as $_id=>$_po):
        $_orderDate = Mage::helper('core')->formatDate($_po->getOrder()->getCreatedAtStoreDate(), 'short', true);
        $_poDate = Mage::helper('core')->formatDate($_po->getCreatedAtStoreDate(), 'short', true);
        ?>
        <tr id="row-<?php echo $_id?>" class="trigger <?php echo $_po->getIsEven() ? 'even' : 'odd'?>">
            <td><a class="action" href="#" onclick="return false"><span></span></a></td>
            <td><?php echo $_po->getIncrementId() ?></td>
            <td><?php echo $_po->getOrder()->getIncrementId() ?></td>
            <td><?php echo $_orderDate ?></td>
            <td><?php echo $_poDate ?></td>
            <td>
                <?php if ($_po->getIsVirtual()): ?>
                <?php echo Mage::helper('udropship')->__('VIRTUAL PO'); ?>
                <?php else: ?>
                <?php echo $_po->getUdropshipMethodDescription() ? $_po->getUdropshipMethodDescription() : Mage::helper('udropship')->__($_vendor->getShippingMethodName($_po->getShippingMethod())) ?>
                <?php endif ?>
            </td>
            <td id="status-<?php echo $_id ?>"><?php echo $_poHlp->getUdpoStatusName($_po) ?></td>
            <td><?php echo $_po->getTotalQty()*1 ?></td>
            <td>
                <a style="white-space:nowrap" href="<?php echo $this->getUrl('udpo/vendor/udpoPdf', array('udpo_id'=>$_po->getId()))?>"><strong><?php echo Mage::helper('udropship')->__('PDF')?></strong></a>
            </td>
        </tr>
        <tr id="info-<?php echo $_id?>" style="display:none">
            <td id="container-<?php echo $_id?>" colspan="10" style="padding:25px; border-top:1px solid #ddd;">
                <span class="udpo-info-loader"><?php echo Mage::helper('udropship')->__('Please wait, loading purchase order information...')?></span>
            </td>
        </tr>
    <?php endforeach ?>
<?php endif ?>
    </tbody>
</table>
<?php echo $this->getChildHtml('toolbar') ?>
</div>

<script type="text/javascript">
var dateFields = ['filter-order_date-from', 'filter-order_date-to', 'filter-po_date-from', 'filter-po_date-to'];

for (var i=0, l=dateFields.length; i<l; i++) {
    Calendar.setup({inputField : dateFields[i], ifFormat : "<?php echo $_dateFormat?>", showsTime : false});
}

var initUdpoGrid = function() {
$$('#udpo-grid tbody tr.trigger').each(function (row) {
    var a = row.down('a.action');
    a.observe('click', expandRow.curry(false, row));
});
}

if ((/msie [1-7]\./i).test(navigator.userAgent)) {
    Event.observe(window, 'load', initUdpoGrid)
} else {
    document.observe("dom:loaded", initUdpoGrid)
}

function expandRow(openFlag, row) {
    var a = row.down('a.action');
    var id = row.id.split('-')[1];
    var info = $('info-'+id), container = $('container-'+id), img = a.down('span');
    if (!info.isInfoLoaded) {
        info.isInfoLoaded = true;
        new Ajax.Updater(container, '<?php echo $_ajaxInfoUrl ?>'.replace('ID', id), {
            onComplete: function (transport) { initUdpoForm.defer(id); },
            evalScripts: true
        });
    }
    if (openFlag) info.show();
    else info.toggle();
    if (info.style.display!='none') {
        img.addClassName('open');
    } else {
        img.removeClassName('open');
    }
}

function onSubmitActionChange(el) {
    if (el.value=='updateUdpoStatus') {
        $('batch_update_status').show();
    } else {
        $('batch_update_status').hide();
    }
}

function massActionSubmit(form) {
    if (validateSearch(form)) {
        action = '<?php echo $this->getUrl('udpo/vendor') ?>'+'?'
        action = action + '&' + serializeFormElements('udpo-filter-form')
        action = action + '&' + serializeFormElements(form.id)
        setLocation(action)
        return true;
    }
    return false;
}

function validateSearch(form) {
    var downloadAction
    switch ($('submit_action').value) {
    case 'udpoMultiPdf':
        if (confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('This action will print PDF for all filtered purchase orders.')) ?>')) {
            downloadAction = true
        }
        break

    case 'udpoLabelBatch':
        if (confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('This action will create shipments and shipping labels for all filtered purchase orders and mark them as shipped.')) ?>')) {
            downloadAction = true
        }
        break

    case 'packingSlips':
        if (confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('This action will print packing slips for all filtered purchase orders and mark them as ready to ship.')) ?>')) {
            downloadAction = true
        }
        break

    case 'existingLabelBatch':
        if (confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('This action will print existing shipping labels for all filtered purchase orders.')) ?>')) {
            downloadAction = true
        }
        break

    case 'createShipmentAndEmail':
        return confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('This action will create shipments for all filtered purchase orders and send customer notification.')) ?>');
        break

    case 'createShipment':
        return confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('This action will create shipments for all filtered purchase orders.')) ?>');
        break

    case 'updateUdpoStatus':
        if (!$('batch_update_status').value) {
            alert('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('Please select a status.')) ?>');
            return false;
        }
        return confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('This action will update status for all filtered purchase orders.')) ?>');
    case 'udbatchExport':
        return true;
    }
    if (downloadAction) {
        var qs = serializeFormElements('udpo-filter-form', true)
        Object.extend(qs, serializeFormElements('udpo-massaction-form', true))
        qs.update_status = ''
        qs.use_json_response = 1
        var ifrId = 'ifr_id_'+(new Date()).getTime()
        if (Prototype.Browser.IE) {
            Element.insert($('download_iframe'), {after: '<iframe id="'+ifrId+'" src="?'+Object.toQueryString(qs)
                +'" style="display:none" onreadystatechange="ieDownloadSubmitWrapper(\''+ifrId+'\')"></iframe>'
            })
        } else {
            Element.insert($('download_iframe'), {after: '<iframe id="'+ifrId+'" src="?'+Object.toQueryString(qs)
                +'" style="display:none" onload="afterDownloadSubmit(\''+ifrId+'\')"></iframe>'
            })
        }
    } 
    return false;
}

function ieDownloadSubmitWrapper(ifrId) {
    if ($(ifrId) && ($(ifrId).readyState=='complete' || $(ifrId).readyState=='interactive')) {
        afterDownloadSubmit.defer(ifrId)
        $(ifrId).onreadystatechange = Prototype.emptyFunction
    }
}

function afterDownloadSubmit(ifrId) {
    var response
    try {
        response = $(ifrId).contentDocument.body.innerHTML.evalJSON()
    } catch(e){}
    if (response && response.error) {
        if (response.message) {
            alert(response.message)
        } else {
            alert('Unknown error')
        }
    } else {
        var qs = serializeFormElements('udpo-filter-form', true)
        Object.extend(qs, serializeFormElements('udpo-massaction-form', true))
        if ($('batch_update_status').value) {
            qs.submit_action = 'updateUdpoStatus'
        } else {
            qs.submit_action = ''
        }
        setLocation('?'+Object.toQueryString(qs))
    }
    //Element.remove($(ifrId))
}

// fix of Prototype.js Form.serialize for IE
function serializeFormElements(form, options) {
    var elements = [];
    $$('#'+form+' *').each(function(child) {
        if (Form.Element.Serializers[child.tagName.toLowerCase()]) {
            elements.push(Element.extend(child));
        }
    });
    return Form.serializeElements(elements, options);
}

function initUdpoForm(id) {
    var statusUpdate = $('status-update-'+id), statusCell = $('status-'+id);
    if (statusUpdate && statusUpdate.innerHTML!=statusCell.innerHTML) {
        statusCell.innerHTML = statusUpdate.innerHTML;
        var h = new Effect.Highlight(statusCell);
    }

    var downloadUrl = $('download-url-'+id);
    if (downloadUrl) {
        $('download_iframe').src = downloadUrl.innerHTML;
    }

    $$('#container-'+id+' .highlight').each(function(el){ var h = new Effect.Highlight(el); });
    $$('#container-'+id+' .item-gift-message-trigger').each(function(el) {
        $(el).observe('click', function(e) {
            e.stop();
            $(this).up().next('div.item-gift-message-content').toggle();
        });
    });

    var hasCanceledItem = 0;

    $$('#order-items-'+id+' tbody tr').each(function(el) {
        var idx = el.id.match(/[0-9]+/);
        if (idx) {
            var qtyShipped = '';
            try {
                qtyShipped = poItemsJson[id][idx]['qty_shipped'];
                hasCanceledItem += poItemsJson[id][idx]['qty_canceled'];
                if (poItemsJson[id][idx]['product_url']) el.down('.product-name').wrap('a', {href: poItemsJson[id][idx]['product_url'], target: '__blank'});
            } catch (e) {}
            $(el).insert({bottom:'<td class="a-center">'+qtyShipped+'</td>'});
        }
    });

    if (hasCanceledItem) {
        $$('#order-items-'+id+' thead tr').each(function(el) {
            $(el).insert({bottom:'<th class="a-center"><?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('Canceled'))?></th>'});
        });
        $$('#order-items-'+id+' tfoot.udropship-totals tr').each(function(el) {
            var td = $(el).down();
            if (td.hasAttribute('colspan')) {
                td.writeAttribute('colspan', 1*td.readAttribute('colspan')+1);
            }
        });
        $$('#order-items-'+id+' tbody tr').each(function(el) {
            var idx = el.id.match(/[0-9]+/);
            var qtyCanceled = '';
            try {
                qtyCanceled = poItemsJson[id][idx]['qty_canceled']; 
            } catch (e) {}
            $(el).insert({bottom:'<td class="a-center">'+qtyCanceled+'</td>'});
        });
    }

    $('submit-'+id) && $('submit-'+id).observe('click', function () {
        var parameters = serializeFormElements('udpo-form-'+id);
        if (parameters == 'tracking_id=&comment=' || !validatePoSubmit(id)) {
            return;
        }
        var parameters = serializeFormElements('udpo-form-'+id);
        $('submit-'+id) && ($('submit-'+id).disabled = true);
        $('addcomment-'+id) && ($('addcomment-'+id).disabled = true);
        $('submit-loader-'+id).show();
//alert(parameters);
        new Ajax.Updater($('container-'+id), '<?php echo $_ajaxPostUrl ?>'.replace('ID', id), {
            method: 'post',
            evalScripts: true,
            parameters: parameters,
            onComplete: function (transport) { initUdpoForm.defer(id); }
        });
    });
    
    $('addcomment-'+id) && $('addcomment-'+id).observe('click', function () {
        if (!validatePoSubmit(id)) {
            return;
        }
        var parameters = serializeFormElements('udpo-form-'+id);
        $('submit-'+id) && ($('submit-'+id).disabled = true);
        $('addcomment-'+id) && ($('addcomment-'+id).disabled = true);
        $('submit-loader-'+id).show();
//alert(parameters);
        new Ajax.Updater($('container-'+id), '<?php echo $_ajaxAddCommentUrl ?>'.replace('ID', id), {
            method: 'post',
            evalScripts: true,
            parameters: parameters,
            onComplete: function (transport) { initUdpoForm.defer(id); }
        });
    });
    if (window['mpsInit'+id]) window['mpsInit'+id]();
}

function validatePoSubmit(id)
{
    if (!$('change_status-'+id)) return true
    if (_validatePoSubmit(id)) {
        if (<?php echo (int)Mage::getStoreConfigFlag('udropship/vendor/allow_forced_po_status_change')?>
            && $('change_status-'+id).value !== ''
            && window.allowedPoStatuses && window.allowedPoStatuses[id]
            && -1 === window.allowedPoStatuses[id].indexOf($('change_status-'+id).value)
        ) {
            if (confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('Such status change is not allowed. Please confirm forced transition')) ?>')) {
                $('force_status_change_flag-'+id).value = '1'
                return true
            } else {
                return false
            }
        } else {
            return true
        }
    } else {
        return false
    }
}

function _validatePoSubmit(id)
{
    switch ($('change_status-'+id).value) {
        case '<?php echo Unirgy_DropshipPo_Model_Source::UDPO_STATUS_CANCELED ?>':
            return confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('This will cancel purchase order and all shipments (if possible).')) ?>');
        case '<?php echo Unirgy_DropshipPo_Model_Source::UDPO_STATUS_SHIPPED ?>':
            return confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('This will mark as shipped purchase order and all shipments (if possible).')) ?>');
        case '<?php echo Unirgy_DropshipPo_Model_Source::UDPO_STATUS_DELIVERED ?>':
            return confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('This will mark as shipped purchase order and all shipments (if possible).'))?>');
        default:
            return true;
    }
}

function initShipmentForm(udpoId, shipmentId) {
    var statusUpdate = $('udpo-status-update-'+udpoId), statusCell = $('status-'+udpoId);
    if (statusUpdate && statusUpdate.innerHTML!=statusCell.innerHTML) {
        statusCell.innerHTML = statusUpdate.innerHTML;
        var h = new Effect.Highlight(statusCell);
    }
    var downloadUrl = $('download-url-'+udpoId);
    if (downloadUrl) {
        $('download_iframe').src = downloadUrl.innerHTML;
    }

    $$('#container-'+udpoId+' .highlight').each(function(el){ var h = new Effect.Highlight(el); });
    $$('#container-'+udpoId+' .item-gift-message-trigger').each(function(el) {
        $(el).observe('click', function(e) {
            e.stop();
            $(this).up().next('div.item-gift-message-content').toggle();
        });
    });

    $('submit-'+udpoId) && $('submit-'+udpoId).observe('click', function () {
        var parameters = serializeFormElements('shipment-form-'+udpoId);
        if (parameters == 'tracking_id=&comment=' || !validateShipmentSubmit(udpoId)) {
            return;
        }
        $('submit-'+udpoId) && ($('submit-'+udpoId).disabled = true);
        $('submit-loader-'+udpoId).show();
//alert(parameters);
        new Ajax.Updater($('container-'+udpoId), '<?php echo $_ajaxShipmentPostUrl ?>'.replace('ID', shipmentId), {
            method: 'post',
            parameters: parameters,
            evalScripts: true,
            onComplete: function (transport) { initShipmentForm.defer(udpoId, shipmentId); }
        });
    });
    if (window['mpsInit'+udpoId]) window['mpsInit'+udpoId]();
}

function validateShipmentSubmit(id)
{
    if (!$('change_status-'+id)) return true;
    switch ($('change_status-'+id).value) {
        case '<?php echo Unirgy_Dropship_Model_Source::SHIPMENT_STATUS_CANCELED ?>':
            return confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('This will cancel shipment (if possible).')) ?>');
        case '<?php echo Unirgy_Dropship_Model_Source::SHIPMENT_STATUS_SHIPPED ?>':
            return confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('This will mark shipment as shipped (and if possible change PO status as well).')) ?>');
        case '<?php echo Unirgy_Dropship_Model_Source::SHIPMENT_STATUS_DELIVERED ?>':
            return confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('This will mark shipment as delivered (and if possible change PO status as well).')) ?>');
        default:
            return true;
    }
}

function useLabelShippingAmountChanged(cb)
{
    var id=cb.id.replace(/[^0-9]/g, '');
    if (cb.checked) {
        $$('#shipping_amount-1-'+id+' input').invoke('disable')
        $('shipping_amount-1-'+id).hide();
    } else {
        $$('#shipping_amount-1-'+id+' input').invoke('enable');
        $('shipping_amount-1-'+id).show();
    }
}
function udpoStatusChanged(sel)
{
    var id=sel.id.replace(/[^0-9]/g, '');
    if (sel.value=='<?php echo Unirgy_DropshipPo_Model_Source::UDPO_STATUS_CANCELED ?>') {
        $$('full-cancel-'+id+' input').invoke('enable');
        $('full-cancel-'+id).show();
    } else {
        $$('full-cancel-'+id+' input').invoke('disable');
        $('full-cancel-'+id).hide();
    }
}

function toggleLabelForm(el, id) {
    var i, l, t;
    for (i=1; i<20; i++) {
        l = $('label_info-'+i+'-'+id);
        t = $('tracking_id-'+i+'-'+id);
        if (el.checked) {
            l && l.show(); t && t.hide();
            $('change_status-'+id) && ($('change_status-'+id).value = '');
        } else {
            l && l.hide(); t && t.show();
            $('is_shipped-'+id) && ($('is_shipped-'+id).checked = false);
        }
    }
    if (!el.checked) {
        showExtraLabelForm(id, false)
    }
}

function syncExtraLabelForm(id)
{
    if ($('form-list-'+id) && $('use_method_code-'+id)) {
        var mCode = $('use_method_code-'+id).value.split('_', 2);
        mCode = mCode[0];
        if (['fedex','fedexsoap'].indexOf(mCode)!=-1) {
            $('form-list-'+id).select('.mps-specific').invoke('show');
            $('form-list-'+id).select('.mps-specific input').invoke('enable');
            $('form-list-'+id).select('.mps-specific select').invoke('enable');
            $('form-list-'+id).select('.mps-specific textarea').invoke('enable');
            $('form-list-'+id).select('.no-mps-specific').invoke('hide');
            $('form-list-'+id).select('.no-mps-specific input').invoke('disable');
            $('form-list-'+id).select('.no-mps-specific select').invoke('disable');
            $('form-list-'+id).select('.no-mps-specific textarea').invoke('disable');
            try {
            syncUseCustomWeight($('form-list-'+id).select('.mps-specific .udlabel-usecustom-weight-checkbox-'+id)[0], id);
            } catch (e) {
            }
        } else {
            $('form-list-'+id).select('.no-mps-specific').invoke('show')
            $('form-list-'+id).select('.no-mps-specific input').invoke('enable');
            $('form-list-'+id).select('.no-mps-specific select').invoke('enable');
            $('form-list-'+id).select('.no-mps-specific textarea').invoke('enable');
            $('form-list-'+id).select('.mps-specific').invoke('hide');
            $('form-list-'+id).select('.mps-specific input').invoke('disable');
            $('form-list-'+id).select('.mps-specific select').invoke('disable');
            $('form-list-'+id).select('.mps-specific textarea').invoke('disable');
            try {
            syncUseCustomWeight($('form-list-'+id).select('.no-mps-specific .udlabel-usecustom-weight-checkbox-'+id)[0], id);
            } catch (e) {}
        }
        $('form-list-'+id).select('.carrier-specific').each(function(el){
            if (!el.hasClassName('carrier-specific-'+mCode) || !$('show_extra_params-'+id).checked) {
                el.select('input').invoke('disable');
                el.select('select').invoke('disable');
                el.select('textarea').invoke('disable');
                el.hide();
            } else {
                el.select('input').invoke('enable');
                el.select('select').invoke('enable');
                el.select('textarea').invoke('enable');
                el.show();
            }
        });
    }
}

function toggleExtraLabelForm(el, id) {
    var i, l, t;
    for (i=1; i<50; i++) {
        l = $('label_info-ext-'+i+'-'+id);
        if (el.checked) {
            l && l.show();
            l && l.select('input').invoke('enable');
            l && l.select('select').invoke('enable');
            l && l.select('textarea').invoke('enable');
        } else {
            l && l.hide();
            l && l.select('input').invoke('disable');
            l && l.select('select').invoke('disable');
            l && l.select('textarea').invoke('disable');
        }
    }
    syncExtraLabelForm(id);
}

function showExtraLabelForm(id, showFlag) {
    var i, l, t;
    for (i=1; i<50; i++) {
        l = $('label_info-ext-'+i+'-'+id);
        if (showFlag) {
            l && l.show();
            l && l.select('input').invoke('enable');
            l && l.select('select').invoke('enable');
            l && l.select('textarea').invoke('enable');
        } else {
            l && l.hide();
            l && l.select('input').invoke('disable');
            l && l.select('select').invoke('disable');
            l && l.select('textarea').invoke('disable');
        }
    }
    syncExtraLabelForm(id);
}

function recalculateLabelTotals(poId) {

    var totalWeight = 0;
    var totalValue = 0;
    for (oItemId in poItemsJson[poId]) {
        var itemId = poItemsJson[poId][oItemId]['item_id'];
        if ($('partial_qty-'+itemId)) {
            totalWeight += Number(poItemsJson[poId][oItemId]['weight'])*$('partial_qty-'+itemId).value;
            totalValue  += Number(poItemsJson[poId][oItemId]['price'])*$('partial_qty-'+itemId).value;
        }
    }

    //$('weight-'+poId).value=totalWeight.toFixed(2);
    //$('value-'+poId).value=totalValue.toFixed(2);
    $$('.udlabel-static-weight-'+poId).each(function(el) {el.update(totalWeight.toFixed(2))});
    $$('.udlabel-static-value-'+poId).each(function(el) {el.update(totalValue.toFixed(2))});
}

function createPoPartialQtySelect(poId, itemId) {
    var qtyToShip = 0;
    var oItemId = itemId;
    try {
        itemId = poItemsJson[poId][oItemId]['item_id'];
        qtyToShip = poItemsJson[poId][oItemId]['qty_to_ship'];
    } catch (e) {}
    var html = '<td class="partial-qty a-center" onChange="recalculateLabelTotals('+poId+')">';
    if (qtyToShip>0) {
        html += '<select name="partial_qty['+itemId+']" id="partial_qty-'+itemId+'">';
        for (var i=0; i<=qtyToShip; i++) {
            if (i==qtyToShip) {
                html += '<option value="'+i+'" selected>'+i+'</option>';
            } else {
                html += '<option value="'+i+'">'+i+'</option>';
            }
        }
        html += '</select>';
    } else {
        html += '&nbsp;';
    }
    html += '</td>';
    return html;
}

function createPoPartialQtyInput(poId, itemId) {
    var qtyToShip = 0;
    var oItemId = itemId;
    try {
        itemId = poItemsJson[poId][oItemId]['item_id'];
        qtyToShip = poItemsJson[poId][oItemId]['qty_to_ship'];
    } catch (e) {}
    var html = '<td class="partial-qty a-center" onChange="recalculateLabelTotals('+poId+')">';
    if (qtyToShip>0) {
        html += '<input name="partial_qty['+itemId+']" id="partial_qty-'+itemId+'" value="'+qtyToShip+'"/>';
    } else {
        html += '&nbsp;';
    }
    html += '</td>';
    return html;
}

function switchPoPartialAvailability(el, id) {
    $$('#order-items-'+id+' .partial-qty').each(function(el) {
        $(el).remove();
        $$('#order-items-'+id+' tfoot.udropship-totals tr').each(function(el) {
            var td = $(el).down();
            if (td.hasAttribute('colspan')) {
                td.writeAttribute('colspan', 1*td.readAttribute('colspan')-1);
            }
        });
    });

    switch (el.value) {
    case 'inform':
        $$('#order-items-'+id+' thead tr').each(function(el) {
            $(el).insert({bottom:'<th class="partial-qty"><?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('Qty Available'))?></th>'});
        });
        $$('#order-items-'+id+' tbody tr').each(function(el) {
            var idx = el.id.match(/[0-9]+/);
            if (!idx) {
                $(el).insert({bottom:'<td class="partial-qty">&nbsp;</td>'});
            } else {
                $(el).insert({bottom:createPoPartialQtyInput(id, idx)});
            }
        });
        $$('#order-items-'+id+' tfoot.udropship-totals tr').each(function(el) {
            var td = $(el).down();
            if (td.hasAttribute('colspan')) {
                td.writeAttribute('colspan', 1*td.readAttribute('colspan')+1);
            }
        });
        break;

    case 'ship':
        $$('#order-items-'+id+' thead tr').each(function(el) {
            $(el).insert({bottom:'<th class="partial-qty"><?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('Left / Ship'))?></th>'});
        });
        $$('#order-items-'+id+' tbody tr').each(function(el) {
            var idx = el.id.match(/[0-9]+/);
            var isVirtual = false
            try {
                isVirtual = poItemsJson[id][idx]['is_virtual']
            } catch (e) {}
            if (!idx || isVirtual) {
                $(el).insert({bottom:'<td class="partial-qty">&nbsp;</td>'});
            } else {
                $(el).insert({bottom:createPoPartialQtyInput(id, idx)});
            }
        });
        $$('#order-items-'+id+' tfoot.udropship-totals tr').each(function(el) {
            var td = $(el).down();
            if (td.hasAttribute('colspan')) {
                td.writeAttribute('colspan', 1*td.readAttribute('colspan')+1);
            }
        });
        break;
    }
}

function toggleSGFilterBox(elem)
{
    $(elem).select('span').invoke('toggleClassName', 'open');
    $(elem).up(4).down('.col3-set',1).toggle();
    $(elem).up(4).down('.buttons-set').toggle();
}

function reprintLabel(udpoId, trackId) {
    $('download_iframe').src = '<?php echo $_reprintUrl ?>'.replace('TRACKID', trackId);
}

function reprintLabelBatch(udpoId, batchId) {
    $('download_iframe').src = '<?php echo $_reprintBatchUrl ?>'.replace('BATCHID', batchId);
}

function udpoDeleteTrack(udpoId, trackId) {
    if (!confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('Proceed with tracking ID deletion?'))?>')) {
        return;
    }
    try {
    new Effect.Highlight($('old_tracking_id-'+trackId));
    } catch (e) {}
    try {
    new Ajax.Updater($('container-'+udpoId), '<?php echo $_ajaxUdpoDeleteTrackUrl ?>'.replace('ID', udpoId), {
        method: 'post',
        parameters: { delete_track:trackId },
        evalScripts: true,
        onComplete: function (transport) { initUdpoForm.defer(udpoId); }
    });
    } catch (e) {}
}

function shipmentDeleteTrack(udpoId, shipmentId, trackId) {
    if (!confirm('<?php echo $this->jsQuoteEscape(Mage::helper('udropship')->__('Proceed with tracking ID deletion?'))?>')) {
        return;
    }
    new Effect.Highlight($('old_tracking_id-'+trackId));
    new Ajax.Updater($('container-'+udpoId), '<?php echo $_ajaxShipmentDeleteTrackUrl ?>'.replace('ID', shipmentId), {
        method: 'post',
        parameters: { delete_track:trackId },
        evalScripts: true,
        onComplete: function (transport) { initShipmentForm.defer(udpoId, shipmentId); }
    });
}

function collapseAllRows() {
    $$('#udpo-grid tbody tr.trigger').each(function(row) {
        var id = row.id.split('-')[1];
        $('info-'+id).hide();
        row.down('a.action span').removeClassName('open');
    });
}

function expandAllRows() {
    $$('#udpo-grid tbody tr.trigger').each(expandRow.curry(true));
}

function showShipmentInfo(udpoId, shipmentId) {
    new Ajax.Updater($('container-'+udpoId), '<?php echo $_ajaxShipmentInfoUrl ?>'.replace('ID', shipmentId), {
        method: 'post',
        evalScripts: true,
        onComplete: function (transport) { initShipmentForm.defer(udpoId, shipmentId); }
    });
}

function showUdpoInfo(udpoId) {
    new Ajax.Updater($('container-'+udpoId), '<?php echo $_ajaxInfoUrl ?>'.replace('ID', udpoId), {
        method: 'post',
        evalScripts: true,
        onComplete: function (transport) { initUdpoForm.defer(udpoId); }
    });
}

var poItemsJson = {};

function selectCarrier(elem, titleId) {
    option = elem.options[elem.selectedIndex];
    if (option.value && option.value != 'custom') {
        $(titleId).value = option.text;
    }
    else {
        $(titleId).value = '';
    }
}

function syncUseCustomWeight(el, poId)
{
    var dynCont = $(el).up().previous('.udlabel-dynamic-container-'+poId);
    if (dynCont) {
        if (!$(el).checked) {
            dynCont.select('.udlabel-dymanic-weight-'+poId+', .udlabel-dymanic-value-'+poId).invoke('disable');
            dynCont.hide();
        } else {
            dynCont.select('.udlabel-dymanic-weight-'+poId+', .udlabel-dymanic-value-'+poId).invoke('enable');
            dynCont.show();
        }
    }
    var statCont = $(el).up().previous('.udlabel-static-container-'+poId);
    if (statCont) {
        if ($(el).checked) {
            statCont.hide();
        } else {
            statCont.show();
        }
    }
}

</script>

<iframe id="download_iframe" name="download_iframe" src="<?php echo
$this->helper('core/js')->getJsUrl('blank.html') ?>" style="display:none"></iframe>
